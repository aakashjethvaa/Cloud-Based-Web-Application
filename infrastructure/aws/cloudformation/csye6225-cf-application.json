{
	"AWSTemplateFormatVersion":"2010-09-09",
	"Description":"Cloud Formation Template - CSYE6225 - Creating EC2 instance , Security Groups and Ingress Rules",
	"Parameters":{
		"EC2Name":{
			"Type":"String"
		},
		"EC2SecurityGroup":{
			"Type":"String"
		},
		"SubnetId1":{
			"Type":"String"
		},
		"VpcId":{
			"Type":"String"
		},
		"EC2VolumeSize":{
			"Type":"String"
		},
		"EC2VolumeType":{
			"Type":"String"
		},
		"AMIImage":{
			"Type":"String"
		},
		"DynamoDBName":{
			"Type":"String"
		},
		"BucketName":{
			"Type":"String"
		},
		"MasterUsername":{
			"Type":"String"
		},
		"MasterUserPwd":{
			"Type":"String"
		},
		"DBName":{
			"Type":"String"
		},
		"DBInstanceClass":{
			"Type":"String"
		},
		"DBInstanceIdentifier":{
			"Type":"String"
		},
		"DBEngine":{
			"Type":"String"
		},
		"SubnetId2":{
			"Type":"String"
		},
		"SubnetId3":{
			"Type":"String"
		},
		"RDSSecurityGroup":{
			"Type":"String"
		},
		"EC2RoleName":{
			"Type":"String"
		}
	},
	"Resources":{
		"ourEC2Instance":{
			"Type":"AWS::EC2::Instance",
			"Properties":{
				"InstanceType":"t2.micro",
				"DisableApiTermination":true,
				"ImageId":{
					"Ref":"AMIImage"
				},
				"UserData":{
					"Fn::Base64":{
						"Fn::Join":[
							"\n",
							[
							"#!/bin/bash -xe ",
                                "yum install ruby ntp wget java-1.8.0-openjdk-devel -y",
                                "systemctl start ntpd",
                                "systemctl enable ntpd"
						]
						]
					}
				},
				"BlockDeviceMappings":[
					{
						"DeviceName":"/dev/sda1",
						"Ebs":{
							"DeleteOnTermination":true,
							"VolumeSize":{
								"Ref":"EC2VolumeSize"
							},
							"VolumeType":{
								"Ref":"EC2VolumeType"
							}
						}
					}
				],
				"Tags": [{
					"Key": "Name",
					"Value": {
						"Ref": "EC2Name"
					}
				}],
				"SecurityGroupIds":[
					{
						"Ref":"EC2SecurityGroup"
					}
				],
				"SubnetId":{
					"Ref":"SubnetId1"
				},
				"IamInstanceProfile":{
					"Ref":"ourIAMInstanceProfile"
				}
			}
		},
		"ourIAMInstanceProfile":{
			"Type":"AWS::IAM::InstanceProfile",
			"Properties":{
				"Path":"/",
				"Roles":[
					{
						"Ref":"EC2RoleName"
					}
				]
			}
		},
		"ourDynamoTable":{
			"Type":"AWS::DynamoDB::Table",
			"Properties":{
				"KeySchema":[
					{
						"AttributeName":"id",
						"KeyType":"HASH"
					}
				],
				"AttributeDefinitions":[
					{
						"AttributeName":"id",
						"AttributeType":"S"
					}
				],
				"TableName":{
					"Ref":"DynamoDBName"
				},
				"ProvisionedThroughput":{
					"ReadCapacityUnits":"5",
					"WriteCapacityUnits":"5"
				}
			}
		},
		"ourS3Bucket":{
			"Type":"AWS::S3::Bucket",
			"Description":"S3 Bucket to store attachment files",
			"Properties":{
				"AccessControl":"Private",
				"BucketName":{
					"Ref":"BucketName"
				}
			}
		},
		"ourRDSDBSubnet":{
			"Type":"AWS::RDS::DBSubnetGroup",
			"Properties":{
				"DBSubnetGroupDescription":"Subnet Group fro RDS Instance",
				"SubnetIds":[
					{
						"Ref":"SubnetId2"
					},
					{
						"Ref":"SubnetId3"
					}
				]
			}
		},
		"ourRDSInstance":{
			"Type":"AWS::RDS::DBInstance",
			"Properties":{
				"AllocatedStorage":"10",
				"MasterUsername":{
					"Ref":"MasterUsername"
				},
				"MasterUserPassword":{
					"Ref":"MasterUserPwd"
				},
				"MultiAZ":false,
				"PubliclyAccessible":false,
				"DBName":{
					"Ref":"DBName"
				},
				"DBInstanceClass":{
					"Ref":"DBInstanceClass"
				},
				"DBInstanceIdentifier":{
					"Ref":"DBInstanceIdentifier"
				},
				"Engine":{
					"Ref":"DBEngine"
				},
				"DBSubnetGroupName":{
					"Ref":"ourRDSDBSubnet"
				},
				"VPCSecurityGroups":[
					{
						"Ref":"RDSSecurityGroup"
					}
				]
			}
		}
	}
}
